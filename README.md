#### 案件概要:

社会保険系法人様の業務システムの大幅刷新案件。運用プラットフォームの AWS 移行、サービスのサーバレス化、運用自動化を目指した開発作業

#### 担当:

プロトタイプ作成と同時に発足したテストチームにおいて、上記の観点を実現するテスト手法（自動化やコード化）や CI/CD 手法の PoC（概念実証）とテスト実施を担当

#### 作業実績:

- 全体テスト計画書の一部を作成（テスト方法、テスト環境、使用ミドルウェア・ソフトウェアなど）
- Selenium(Python)を使用した 結合テスト自動化/コード化/バージョン管理(Git, CodeCommit)の提案
- Python のバックエンドコード(Lambda で動作)に対する 単体テスト自動化/モック化 の提案と、サンプルテストコード, サンプルプロジェクト(ディレクトリ構成や設定ファイルの雛形を配置)の提供
- JavaScript(Vue.js)のフロントエンドコードに対する 単体テスト自動化/ モック化 手法の提案と、サンプルテストコード, サンプルプロジェクト(ディレクトリ構成や設定ファイルの雛形を配置)の提供
- CodePipeline を使用した CI/CD パイプラインのアーキテクチャ構成の提案と概念実証
- SAM デプロイ(CloudFormation)用のテンプレートファイルや、リポジトリ内の StepFunctions スタックを再帰的に自動デプロイするスクリプトを作成
- テストチームメンバーに対して、各種 AWS リソースの使用方法や確認方法のスキルトランスファー、およびドキュメントを作成・整備
  - AWS CLI の使いかたや RDS Aurora, DynamoDB へのデータ投入方法など

### 振り返った感想

AWS におけるクラウド戦略でいうところの「リファクタリング」戦略に相当する、ほぼ新規開発案件に序盤から参画しました。自分が案件に参画した時点で仕事（今回の場合「テスト」）の進め方が決まっていない状況が初めて、かつ、「自動化したテスト手法を考えてほしい」と頼まれた時は、かなり戸惑いましたが、必死に調査を進めて提案を練り上げ、その提案が（全て採用された訳ではありませんでしたが）受け入れられ、プロジェクト全体で実践されていく、という体験はとても面白く実力もついたと思います。

テストチームとして最終的には 10 名以上のメンバーが集まりましたが、AWS について少しでも知見のあるメンバーは自分 1 人という状況だったので、テストに必要な AWS リソースの使い方やデータ投入方法（例えば、 Cognito の ユーザーやプロパティの追加方法だったり、AWS CLI をインストールして開発用ロールを使うための設定だったり）を全て自分が調査してドキュメント化して回ったので、 AWS リソースについて広く知見を貯められたかなと思います。

一方で、自動化構成（CI/CD）については自分の思い描いた構成が（開発速度の観点から）実現できず、中等半端になってしまって歯がゆい思いをしました。特に CodePipline については、上位ベンダーとの役割分担の都合上、作成の許可が降りず、また保守フェーズを見据えてデプロイ管理が自分の手から離れてしまい、各種 Lambda や Step Functions について、デプロイ担当者のローカル端末に最新のソースコードを clone した上でのデプロイするフローとなっていたので、Git の操作ミスなどに起因するデプロイミスや、一部機能に関する特殊なデプロイに関する手法や知識が属人化した結果、担当者の離任後にこれもまたデプロイミスが起きるなど、アンチパターンを実践する結果となっていました。

#### 案件概要:

お客様先となる不動産情報サイト運営企業様では稼働しているシステムのプラットフォームを AWS へ移行中だが、一部の社内ツールについては移行が積み残されている状況で、その 1 つについて AWS 移行およびシステムの最新化を行うことが決まった

#### 担当:

該当の社内ツールについて AWS 移行とシステムの最新化を担当。また、ツールの移行作業完了後はメインサイトの AWS 移行のテスト故障の調査と対応を担当した

#### 作業実績:

##### ツール移行【PHP, JavaScript, AWS】

- オンプレ環境から抽出してきた PHP ソースコードを Amazon Linux2 へ移植
- 動作する PHP のバージョンアップ要件があった(移植前の動作バージョンは PHP4)ので、PHP7.1 をインストールし、廃止関数などをリファクタリング
- ツール内で発行される SQL 文について、移行後の環境に合わせてリファクタリング(Oracle から PostgreSQL へ)
- 作業開始後、廃止された DB を参照している処理が急遽見つかっため、代替として API サーバーへ Get 処理を行うように機能修正
- 全体的にバグが放置されていたので、フィックスして処理を高速化
- 新規に監査用の操作ログをローカルに生成して永続化する要件があったので、新規にロギング機能を開発して特定操作時にログ生成し、
  Cron と Shell(AWS CLI) で S3 バケットに定時転送する処理を新規実装
  - ユーザー管理用の DB を同居させる構成だったので、こちらについても自動でダンプを作成し S3 に定時バックアップするようにスクリプトを作成
- 上記で作成したインスタンスを AMI 化し、本番環境で展開する手順書を作成
- Puppeteer を使用して自動 E2E テストを実施(自動入力、自動操作、負荷試験)
- CloudWatch Events ルール と Lambda(Python) による、スケジューリングされたインスタンス稼働を実装

##### テスト故障対応【PHP, Java】

- テスト故障の原因切り分けと対応を行った
- Java で作成された API サーバーのバグフィックスや、Oracle から PostgreSQL への SQL 書き換えミスの対応

### 振り返った感想

業務環境で稼働している AWS リソースを初めて触った案件です。「（要件を満たしていれば）何でも好きな AWS サービス、ミドルウェアを使っていいよ」と言われていましたが、当時はそこまで AWS 知識がなかったので、「AMI から EC2 を起動する。DB や ログデータのバックアップは cron で EC2 から S3 に転送する」というシンプルな構成に仕上がりました。

Puppeteer という Web スクレイピングライブラリを使用した自動 E2E テストについても、自分から提案して実装したものですが、この挑戦があったからこそ次の「サーバレス業務システム開発」についてテストチームとして声がかかったのかなと認識していて、やってよかったなと思っています。
