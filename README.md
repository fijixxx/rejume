### 案件概要

社会保険系法人様の業務システムの大幅刷新案件。運用プラットフォームの AWS 移行、サービスのサーバレス化、運用自動化を目指した開発作業

### 担当

プロトタイプ作成と同時に発足したテストチームにおいて、上記の観点を実現するテスト手法（自動化やコード化）や CI/CD 手法の PoC（概念実証）とテスト実施を担当

### 作業概要

AWS におけるクラウド戦略でいうところの「リファクタリング」戦略に相当する、ほぼ新規開発の案件に序盤から参画しました。自分が案件に参画した時点で仕事（今回の場合「テスト」）の進め方が決まっていない状況が初めて、かつ、「自動化したテスト手法を考えてほしい」と頼まれた時は、かなり戸惑いましたが、必死に調査を進めて提案を練り上げ、それらの提案が（全て採用された訳ではありませんでしたが）受け入れられ、プロジェクト全体で実践されていく、という体験はとても面白く実力もついたと思います。

### 作業実績

#### CI の提案

参画後、最初に手掛けた仕事は「単体・結合テスト自動化」をどのように実現するかを考案することでした。単体テストに関しては、「スタブ DB を立てて、実際に DB へのアクセスをテストする」のと「Mock 機能を利用し、DB からの応答は 固定値でテストする」の 2 択を技術コンサルチームの方に提案したところ、動作パフォーマンスの観点から後者がよいと助言を受け、結合テストに関しては、PM の方から「Selenium のようなソフトウェアを使ってやりたいと考えている」との要望を受けていました。これらの状況を検討し、また前提として、リソース（ソースコード（CodeCommit）やアプリ（Lambda））は AWS 上に集約させる、とのことだったので、CodeBuild で CI 用の Windows Server (動作環境に合わせて)を 立て、単体テストと結合テストを実行することを考案しました。単体テストであれば、リリース用ブランチ へのマージ時に CodePipeline が起動し、CI 用 Windows Server 上で各ソースコードに対しての単体テストが網羅的に走り(こちらは、 nose というフレームワークを利用)、結合テストであれば、CI 用 Windows Server の中で Selenium WebDriver を起動し、 VPC を通ってフロントエンドをホストしている S3 を叩いて結合テストを行う、といったことを考案しました。 ただし、こちらは実現可能性を検証し、開発リーダー層への最初の提案を行ったところで、「ビジネス面の観点から ステージ(テスト)環境にソースコード以外のリソースを作成することは難しい(顧客へサービスとして提供する AWS 環境が別のベンダーの管轄のため)とのことだったので、それぞれ、テスト手法はそのままで、動作環境をライブラリ管理者やテスターのローカル端末に変更した構成での実施となりました。

#### テストチームにおける、AWS リソース利用の窓口・ドキュメント作成

テストチームとして最終的には 10 名以上のメンバーが集まりましたが、AWS について少しでも知見のあるメンバーは自分 1 人という状況だったので、テストに必要な AWS リソースの利用について上位ベンダーの方と検討したり(Redmine チケット上や Teams, 対面での打ち合わせ)、それらの使い方やデータ投入方法（例えば、 Cognito の ユーザーやプロパティの追加方法だったり、AWS CLI をインストールして開発用ロールを使うための設定だったり）を調査してテストチームメンバー向けに説明したり、ドキュメント化して回ったので、 AWS リソースについて広く知見を貯められたかなと思います。

#### 反省点(CD について)

CodePipline について、先述した通り、上位ベンダーとの役割分担の都合上、ステージ環境上への作成の許可が降りず、また(保守フェーズを見据えて)デプロイ管理が自分の手から離れてしまい、各種 Lambda や Step Functions でのステートマシン JSON のテスト用差し替えについて、デプロイ担当者のローカル端末でソースコードを clone し何らかの作業を行った上でデプロイするフローとなっていました。これらは Git の操作ミスなどに起因するデプロイミスを誘発し、また、一部の特殊なデプロイに関しては、故障対応後の再デプロイの際に時間がかかったりデプロイミスが起こっていました。また、デプロイ知識や手法が属人化してしまうことで、担当者の離任後に引き継ぎ者によるデプロイがうまくいかず、トラブルシューティングに時間がかかってしまうなど、アンチパターンを実践する結果となっていました。

こちらについては、何らかの手段でデプロイ手順やデプロイするリソースの「コード化(IaC)と共有」によって再現性のあるデプロイを実行できていれば、上記のような失敗を防げたと考えています。今回の場合、 CI については「ビジネス観点から、(ステージ(テスト)環境上にはアプリソースコード以外の)リソースは配置できない」と断られていたのですが、 CD については、上記の通りにローカル環境からステージ環境のリソースを自由に扱える IAM ユーザーとロールが払い出されていたので、例えば、開発環境上に CodePipeline を構築し、ステージ環境の IAM ユーザーとロールのクレデンシャルで CodeBuild を動作させたり、あるいは 開発環境にライブラリ管理用の共有 EC2 を立てて、そこにデプロイ用のシェルやソースコードを配置し、同様にステージ環境のクレデンシャルで動作させるなど、何かしら手は打てたのかなと、振り返っています。

### 案件概要

お客様先となる不動産情報サイト運営企業様では稼働しているシステムのプラットフォームを AWS へ移行中だが、一部の社内アプリ(ツール)については移行が積み残されている状況で、その 1 つについて AWS 移行およびシステムの最新化を行うことが決まった

### 担当

該当のアプリについて AWS 移行とシステムの最新化を担当。また、アプリの移行作業完了後はメインサイトの AWS 移行のテスト故障の調査と対応を担当した

### 作業概要

業務環境で稼働している AWS リソースを初めて触った案件です。「（要件を満たしていれば）何でも好きな AWS サービス、ミドルウェアを使っていいよ」と言われていましたが、今回、自分が以降を担当したアプリは特にミッションクリティカルなシステムではなかったため、そこまで複雑な構成とせず、「AMI から EC2 を起動する。DB や ログデータのバックアップは cron で EC2 から S3 に転送する」というシンプルな構成に仕上がりました。

Puppeteer という Web スクレイピングライブラリを使用した自動 E2E テストについても、自分から提案して実装したものですが、この挑戦があったからこそ次の「サーバレス業務システム開発」についてテストチームとして声がかかったのかなと認識していて、やってよかったなと思っています。

また、ツール以降完了後に余った契約期間では フロントサーバー/PHP, API サーバー/Java のメディアサービスのテスト障害対応を行っていました。

### 作業実績

移行するアプリのソースコードについては、すでにファイルサーバーに配置してもらったところから案件が開始しました。SE の方からは、

- ミドルウェアを更新してほしい(PHP4 -> PHP7.1)
- アプリ内の機能について整理し、使っていない機能のコードについては削除してほしい
- 最終的な成果物は AMI にしてほしい
- バックアップを定期的にとってほしい
- 監査用の操作ログをとってほしい
- 運用コスト(EC2 をホスティングする費用)は最小限にしてほしい

以上の要望を受けていました。

#### ミドルウェア更新

これらの要望に対応する作業の中で特に印象深かったのは、PHP のバージョンアップにともなう組み込み関数の置き換え作業でした。バージョンが一気にあがったため(4 -> 7.1)

##### ツール移行【PHP, JavaScript, AWS】

- オンプレ環境から抽出してきた PHP ソースコードを Amazon Linux2 へ移植
- 動作する PHP のバージョンアップ要件があった(移植前の動作バージョンは PHP4)ので、PHP7.1 をインストールし、廃止関数などをリファクタリング
- ツール内で発行される SQL 文について、移行後の環境に合わせてリファクタリング(Oracle から PostgreSQL へ)
- 作業開始後、廃止された DB を参照している処理が急遽見つかっため、代替として API サーバーへ Get 処理を行うように機能修正
- 全体的にバグが放置されていたので、フィックスして処理を高速化
- 新規に監査用の操作ログをローカルに生成して永続化する要件があったので、新規にロギング機能を開発して特定操作時にログ生成し、
  Cron と Shell(AWS CLI) で S3 バケットに定時転送する処理を新規実装
  - ユーザー管理用の DB を同居させる構成だったので、こちらについても自動でダンプを作成し S3 に定時バックアップするようにスクリプトを作成
- 上記で作成したインスタンスを AMI 化し、本番環境で展開する手順書を作成
- Puppeteer を使用して自動 E2E テストを実施(自動入力、自動操作、負荷試験)
- CloudWatch Events ルール と Lambda(Python) による、スケジューリングされたインスタンス稼働を実装

##### テスト故障対応【PHP, Java】

- テスト故障の原因切り分けと対応を行った
- Java で作成された API サーバーのバグフィックスや、Oracle から PostgreSQL への SQL 書き換えミスの対応
